name: Grade Monitor (Vacation Mode)

on:
  schedule:
    # æ¯2å°æ—¶æ£€æŸ¥ä¸€æ¬¡
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  check-vacation:
    runs-on: ubuntu-latest
    outputs:
      is_vacation: ${{ steps.vacation_check.outputs.is_vacation }}
      period_info: ${{ steps.vacation_check.outputs.period_info }}
    
    steps:
    - name: Check if current time is in vacation period
      id: vacation_check
      run: |
        current_month=$(date +%m)
        current_day=$(date +%d)
        
        echo "å½“å‰æ—¥æœŸ: $(date +%Y-%m-%d)"
        
        is_vacation=false
        period_info=""
        
        # å¯’å‡æœŸé—´ï¼š1æœˆ16æ—¥ - 2æœˆ28æ—¥
        if [[ ($current_month -eq 01 && $current_day -ge 16) || \
              ($current_month -eq 02 && $current_day -le 28) ]]; then
          is_vacation=true
          period_info="å¯’å‡"
        fi
        
        # æš‘å‡æœŸé—´ï¼š7æœˆ16æ—¥ - 8æœˆ31æ—¥
        if [[ ($current_month -eq 07 && $current_day -ge 16) || \
              ($current_month -eq 08 && $current_day -le 31) ]]; then
          is_vacation=true
          period_info="æš‘å‡"
        fi
        
        # è®¾ç½®å…¶ä»–æ—¶æœŸçš„æè¿°
        if [[ "$is_vacation" == "false" ]]; then
          if [[ ($current_month -ge 03 && $current_month -le 07 && $current_day -le 15) ]]; then
            period_info="æ˜¥å­£å­¦æœŸ"
          elif [[ ($current_month -ge 09) || ($current_month -eq 01 && $current_day -le 15) ]]; then
            period_info="ç§‹å­£å­¦æœŸ"
          fi
        fi
        
        echo "is_vacation=$is_vacation" >> $GITHUB_OUTPUT
        echo "period_info=$period_info" >> $GITHUB_OUTPUT
        
        if [[ "$is_vacation" == "true" ]]; then
          echo "âœ… å½“å‰å¤„äº $period_info æœŸé—´ï¼Œæ‰§è¡Œæˆç»©ç›‘æ§ï¼ˆå¯èƒ½æœ‰è¡¥è€ƒ/é‡ä¿®æˆç»©ï¼‰"
        else
          echo "âŒ å½“å‰å¤„äº $period_info æœŸé—´ï¼Œè·³è¿‡æˆç»©ç›‘æ§"
        fi

  monitor-grades:
    needs: check-vacation
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨å‡æœŸæ‰è¿è¡Œç›‘æ§
    if: needs.check-vacation.outputs.is_vacation == 'true'
    
    steps:
    - name: Show vacation monitoring info
      run: |
        echo "ğŸ–ï¸ ${{ needs.check-vacation.outputs.period_info }}æˆç»©ç›‘æ§å¯åŠ¨"
        echo "ğŸ“‹ ç›‘æ§è¡¥è€ƒã€é‡ä¿®ã€å»¶è¿Ÿå‘å¸ƒçš„æˆç»©"
        echo "â° æ£€æŸ¥æ—¶é—´ï¼š$(date)"
    
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install --no-cache-dir requests pyquery pycryptodome certifi
    
    - name: Run grade monitor
      env:
        STUDENT_USERNAME: ${{ secrets.STUDENT_USERNAME }}
        STUDENT_PASSWORD: ${{ secrets.STUDENT_PASSWORD }}
        WECHAT_WEBHOOK: ${{ secrets.WECHAT_WEBHOOK }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GIST_ID: ${{ secrets.GIST_ID }}
      run: |
        python grade_monitor.py

  semester-notice:
    needs: check-vacation
    runs-on: ubuntu-latest
    # åªåœ¨å­¦æœŸæœŸé—´è¿è¡Œè¿™ä¸ªé€šçŸ¥
    if: needs.check-vacation.outputs.is_vacation == 'false'
    
    steps:
    - name: Semester period notice
      run: |
        echo "ğŸ“š å½“å‰å¤„äºï¼š${{ needs.check-vacation.outputs.period_info }}"
        echo "ğŸ’¤ ç›‘æ§ç³»ç»Ÿå·²æš‚åœï¼ˆå­¦æœŸæœŸé—´æ— éœ€ç›‘æ§ï¼‰"
        echo "â° æ£€æŸ¥æ—¶é—´ï¼š$(date)"
        echo "ğŸ”„ å‡æœŸå¼€å§‹åå°†è‡ªåŠ¨å¯åŠ¨ç›‘æ§"
